<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Out of core text classification with Scikit Learn â€” Eric's Blog</title>
	<meta name="description" content="Title: Out of core text classification with Scikit Learn; Date: 2018-02-02; Author: Eric Daoud">
	<meta name="author" content="Eric Daoud">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://ericdaat.github.io/theme/html5.js"></script>
		<![endif]-->
	<link href="https://ericdaat.github.io/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="https://ericdaat.github.io/theme/css/local.css" rel="stylesheet">
	<link href="https://ericdaat.github.io/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="https://ericdaat.github.io/">Eric's Blog</a>
			<br><small>Data Scientist, Full Stack Developer</small></h1>	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">Out of core text classification with Scikit Learn</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">Eric Daoud</h4>
		</span>
		<time datetime="2018-02-02T10:20:00+01:00" itemprop="datePublished">Fri 02 February 2018</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="https://ericdaat.github.io/category/programming.html" rel="category">Programming</a>
		</span>
	</div>
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="https://ericdaat.github.io/tag/scikit-learn.html" rel="tag">scikit-learn</a>
		</span>
		<span itemprop="keywords">
			<a href="https://ericdaat.github.io/tag/code.html" rel="tag">code</a>
		</span>
		<span itemprop="keywords">
			<a href="https://ericdaat.github.io/tag/machine-learning.html" rel="tag">machine-learning</a>
		</span>
		<span itemprop="keywords">
			<a href="https://ericdaat.github.io/tag/classification.html" rel="tag">classification</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><p>In this article, we are going to demonstrate how to build a simple text classifier for larger than RAM datasets. This approach is called Out of Core Learning, and many python Machine Learning librairies make this very easy to implement. For this example I used reviews from the <a href="https://www.yelp.com/dataset/challenge">Yelp Dataset Challenge</a> and Python <a href="http://scikit-learn.org/stable/">scikit-learn</a> library.</p>
<h2>The Dataset</h2>
<p>First, download the dataset from the <a href="https://www.yelp.com/dataset/challenge">Yelp website</a>. Once you're done, we are going to work with the the reviews file. It contains one Json per row, and I like to use the <a href="https://pandas.pydata.org/">Python Pandas</a> library to read datasets.<br>
Pandas has a nice function called <code>read_json</code> that we are going to use for reading the dataset. However we have to be careful of two things:</p>
<ul>
<li>The dataset is really large, so we don't want to fully load it in RAM</li>
<li>It's not really a Json file, it has one Json per line</li>
</ul>
<p>Thankfully, Pandas is so awesome that it provides everything we need to address these two issues. We are going to use <code>chunksize</code> to tell pandas to load the file chunk by chunk, and <code>lines=True</code> to tell Pandas that the file is not one full json but multiple json rows.</p>
<p>The function will look like this:</p>
<div class="highlight"><pre><span></span><span class="n">dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;./yelp_academic_dataset_review.json&#39;</span><span class="p">,</span>
                   <span class="n">lines</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">chunksize</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</pre></div>


<p>The <code>dfs</code> variable is a generator, on which we will iterate to get the Dataframe chunks.</p>
<p>We are mainly interested in two columns from this dataframe:</p>
<ul>
<li><em>text</em>: The text from the user review.</li>
<li><em>stars</em>: How many stars did the user give.</li>
</ul>
<p>We will simply do a binary classification, and predict whether the review was positive or negative. For this, we take the assumption that a positive review has a rating greater than 3. We can create a new column called <em>sentiment</em> with the following code:</p>
<div class="highlight"><pre><span></span><span class="n">df_</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>


<p>Our input data will be <em>text</em>, and the target <em>sentiment</em>.</p>
<h2>The Classifier Model</h2>
<p>Now that the dataset is ready, we shall turn our input text data into something that a computer might understand. We want to map the reviews as vectors in a fixed size space: the vocabulary. Scikit-learn offers tons of ways of doing it, like <a href="http://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.CountVectorizer.html#sklearn.feature_extraction.text.CountVectorizer">CountVectorizer</a> or <a href="http://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.TfidfVectorizer.html">TfidfVectorizer</a>, etc ...</p>
<p>These are great, but they won't work for a larger than RAM dataset, specifically because we can't load the full corpus in RAM, hence we can't learn the full vocabulary base. Instead, we are going to use the <a href="http://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.HashingVectorizer.html#sklearn.feature_extraction.text.HashingVectorizer">HashingVectorizer</a> which uses the hashing trick: every word gets hashed into an integer index that we then use to compute the term-document matrix. Hence, not much has to fit in memory and this approach can scale to very large datasets.</p>
<div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">HashingVectorizer</span><span class="p">()</span>
<span class="n">v</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="s1">&#39;some text&#39;</span><span class="p">])</span> <span class="c1"># a 1*N matrix where every</span>
                           <span class="c1"># number is 0 except for two</span>
</pre></div>


<p>Now, we can train a classifier on top of this incoming data. Although, the classifier has to support the <code>partial_fit</code> method, otherwise the model will be overridden at each epoch. <a href="http://scikit-learn.org/stable/modules/generated/sklearn.linear_model.SGDClassifier.html">SGDClassifier</a> is among the classifiers that supports that, and it works pretty well so we will use this one.<br>
From there it is very similar to other classifiers, except we use <code>partial_fit</code> instead of <code>fit</code>. We will simply loop over the incoming data chunks, transform the raw text into a term-document matrix thanks to the vectorizer, and then train the model, effectively keeping the previously learned weights.</p>
<h2>Full Code</h2>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">HashingVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">SGDClassifier</span>


<span class="n">dfs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s1">&#39;./yelp_academic_dataset_review.json&#39;</span><span class="p">,</span>
                   <span class="n">lines</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">chunksize</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>

<span class="n">v</span> <span class="o">=</span> <span class="n">HashingVectorizer</span><span class="p">()</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">SGDClassifier</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfs</span><span class="p">):</span>
    <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">text_train</span><span class="p">,</span> <span class="n">text_val</span><span class="p">,</span> <span class="n">target_train</span><span class="p">,</span> <span class="n">target_val</span> <span class="o">=</span> \
        <span class="n">train_test_split</span><span class="p">(</span><span class="n">df_</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="n">df_</span><span class="p">[</span><span class="s1">&#39;sentiment&#39;</span><span class="p">])</span>

    <span class="n">clf</span><span class="o">.</span><span class="n">partial_fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">text_train</span><span class="p">),</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">target_train</span><span class="p">,</span>
                    <span class="n">classes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">val_score</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">text_val</span><span class="p">),</span> <span class="n">target_val</span><span class="p">)</span>
    <span class="k">print</span> <span class="s1">&#39;Batch {0}, val score {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">val_score</span><span class="p">)</span>
</pre></div>


<p>And here is the output of our program: our model learns pretty well ! Note that I haven't done any preprocessing or fine tuning other than what's set by default.</p>
<div class="highlight"><pre><span></span>Batch 1, val score 0.8376
Batch 2, val score 0.7568
Batch 3, val score 0.8472
Batch 4, val score 0.8504
Batch 5, val score 0.8272
Batch 6, val score 0.7992
Batch 7, val score 0.8096
Batch 8, val score 0.812
Batch 9, val score 0.8496
Batch 10, val score 0.8072
Batch 11, val score 0.8944
Batch 12, val score 0.8304
Batch 13, val score 0.8096
...
Batch 418, val score 0.9248
Batch 419, val score 0.92
Batch 420, val score 0.9136
Batch 421, val score 0.9216
Batch 422, val score 0.9088
Batch 423, val score 0.9136
Batch 424, val score 0.916
Batch 425, val score 0.9096
Batch 426, val score 0.9248
Batch 427, val score 0.9184
Batch 428, val score 0.916
Batch 429, val score 0.9072
</pre></div>


<p>I hope this post was useful. Don't hesitate to have a look at scikit-learn documentation on this topic: <a href="http://scikit-learn.org/stable/modules/scaling_strategies.html">Strategies to scale computationally: bigger data</a>.</p></div>
	<hr>
    <!-- <h2>Comments</h2> -->
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://ericdaat.github.io">Eric's Blog</a></li>
							<li><a href="https://ericdaat.github.io//archives.html"><i class="fa fa-Archives "></i> Archives</a></li>
							<li><a href="https://ericdaat.github.io//categories.html"><i class="fa fa-Categories "></i> Categories</a></li>
							<li><a href="https://ericdaat.github.io/pages/about-me.html"><i class="fa fa-About me "></i> About me</a></li>
							<li><a href="https://ericdaat.github.io/feeds/all.atom.xml" type="application/atom+xml"><i class="fa fa-rss "></i> atom</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://github.com/ericdaat">Github</a></li>
							<li><a href="https://twitter.com/ericdaoud">Twitter</a></li>
							<li><a href="https://www.youtube.com/user/ericmusic13">Youtube</a></li>
							<li><a href="https://www.linkedin.com/in/ericdaoud/">Linkedin</a></li>
							<li><a href="https://500px.com/ericda">500px</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://ericdaat.github.io/category/programming.html">Programming (8)</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; Eric Daoud 2016</p>
			<p>Powered by Pelican</p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-105599779-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>